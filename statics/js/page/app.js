//for photo-wall
//
honey.def(function(a){var b=Backbone.Model.extend({initialize:function(){this.loadImg(),this.on("change",this.loadImg,this)},loadImg:function(){if(!this.get("src"))return;var a=this,b=new Image;b.onload=function(){a.trigger("loaded")},b.onerror=function(){a.trigger("imgerr")},b.src=this.get("src")},urlRoot:"/api/view"}),c=Backbone.Collection.extend({initialize:function(){console.log("Collection OK")},model:b,url:"/api/list"}),d=Backbone.View.extend({tagName:"li",template:_.template($("#tmpl-item").html()),render:function(){var a=this.model.toJSON(),b=this.template(a);return this.$el.html(b),this}}),e=Backbone.View.extend({tagName:"ul",initialize:function(){this.itemLoadNum=0},renderItem:function(a){var b=new d({model:a});a.on("loaded",this.itemLoaded,this),this.$el.append(b.render().el)},itemLoaded:function(){this.itemLoadNum++,this.itemLoadNum==this.collection.length&&this.trigger("allItemLoaded")},render:function(){return this.collection.each(this.renderItem,this),this}}),f=Backbone.Router.extend({routes:{"/view/:pid":"view","*actions":"list"},initialize:function(){this.loadingBox=$("#loading"),this.container=$("#container")},loading:function(a){a?(this.container.show(),this.loadingBox.hide()):(this.container.hide(),this.loadingBox.show())},list:function(){console.log("list"),this.loading();var a=this,b=a.container,d=new c,f=new e({collection:d});d.on("reset",function(){var a=this.render().el;b.html(a)},f),f.on("allItemLoaded",function(){a.loading("hide"),b.find("ul").isotope({itemSelector:"li",layoutMode:"masonry"})}),d.fetch()},view:function(a){this.loading();var c=this,e=new b({id:a});e.on("imgerr",function(){c.container.html("Can not load this Photo!"),c.loading("hide")},e),e.on("loaded",function(){var a=new d({model:this,el:$("#container")});a.render(),c.loading("hide")},e),e.fetch()}});a.app=function(){var a=new f;Backbone.history.start()}});